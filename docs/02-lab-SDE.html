<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Mathematical Ecology - 4&nbsp; The stochastic difference equations and analogous deterministic equations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./01-lab-BirthProcess.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The stochastic difference equations and analogous deterministic equations</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Mathematical Ecology</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introduction to Mathematical Ecology</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lec01-BirthProcess.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Simple Death Process</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00-lab-R-intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-lab-BirthProcess.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">The GillespieSSA routines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-lab-SDE.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The stochastic difference equations and analogous deterministic equations</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#τ-leaping" id="toc-τ-leaping" class="nav-link active" data-scroll-target="#τ-leaping"><span class="toc-section-number">4.1</span>  τ-leaping</a></li>
  <li><a href="#continuous-state-approximations" id="toc-continuous-state-approximations" class="nav-link" data-scroll-target="#continuous-state-approximations"><span class="toc-section-number">4.2</span>  Continuous state approximations</a></li>
  <li><a href="#the-analogous-differential-equation" id="toc-the-analogous-differential-equation" class="nav-link" data-scroll-target="#the-analogous-differential-equation"><span class="toc-section-number">4.3</span>  The analogous differential equation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The stochastic difference equations and analogous deterministic equations</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="τ-leaping" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="τ-leaping"><span class="header-section-number">4.1</span> τ-leaping</h2>
<p>As populations get larger, inter-event times get shorter and simulations using the Gillespie-SSA can be time-consuming. One method to speed up computations, at the expense of some of the exactness of the Gillespie algorithm, is to take fixed time steps of some length <span class="math inline">\(\tau\)</span> and approximate the number of events as a Poisson random variable.</p>
<p>Consider again the simple birth process with rate <span class="math inline">\(b\)</span>. We found the number of births in a time <span class="math inline">\(t\)</span> was a Poisson random variable with parameter <span class="math inline">\(bt\)</span>. These results are easy to extend to the nonlinear birth-death process <span class="citation" data-cites="Allen2011stochastic">(see <a href="#ref-Allen2011stochastic" role="doc-biblioref">Allen 2011</a>)</span>. To simplify our previous notation, suppose <span class="math inline">\(b_n\)</span> and <span class="math inline">\(d_n\)</span> are the birth and death rates given a current population size <span class="math inline">\(n\)</span>. Thus in a (vanishingly) small time interval <span class="math inline">\(\tau\)</span>, a single birth occurs with probability <span class="math inline">\(b_n\tau + o(\tau)\)</span>, a single death occurs with probability <span class="math inline">\(d_n\tau + o(\tau)\)</span>, a combination of the two events occurs with probability <span class="math inline">\(o(\tau)\)</span>, and neither event occurs with probability <span class="math inline">\(1 - (b_n + d_n)\tau + o(\tau)\)</span>. Allowing a longer time step, still denoted by <span class="math inline">\(\tau\)</span>, the number of births and deaths occurring during the step are Poisson random variables with rates <span class="math inline">\(b_n\tau\)</span> and <span class="math inline">\(d_n\tau\)</span> respectively.</p>
<p>To illustrate, use our logistic birth-death process with <span class="math inline">\(b_n = bn\)</span> and <span class="math inline">\(d_n = (d+cn)n\)</span>. We’ll refer to <span class="math inline">\(b_n\)</span> and <span class="math inline">\(d_n\)</span> as the birth and rates and to <span class="math inline">\(b\)</span> and <span class="math inline">\(d\)</span> as the per-capita birth and death rates.</p>
<p>First, set up the birth and death rates and pick some parameters.</p>
<div class="cell" data-hash="02-lab-SDE_cache/html/unnamed-chunk-1_7fa0abc176d3b0bbbaf22545673750de">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>births <span class="ot">=</span> <span class="cf">function</span>(n) b<span class="sc">*</span>n</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>deaths <span class="ot">=</span> <span class="cf">function</span>(n) (d<span class="sc">+</span>((b<span class="sc">-</span>d)<span class="sc">/</span>K)<span class="sc">*</span>n)<span class="sc">*</span>n</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fl">0.006</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>K<span class="ot">=</span><span class="dv">500</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>No <span class="ot">=</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With these rates, we should expect on average 5 births and 5 deaths per unit time at a population of 500. If we take a step size of 20 time units, we expect 100 births and 100 deaths on average. This may seem large, but the standard deviation of the Poisson distribution with mean 100 is 10.</p>
<div class="cell" data-hash="02-lab-SDE_cache/html/unnamed-chunk-2_ac46bde5c2b5f4564cf83b7a7159c889">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>stepsize <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>times <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="at">by=</span>stepsize,<span class="at">length=</span><span class="dv">100</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="fu">length</span>(times),<span class="at">ncol=</span>samples)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>N[<span class="dv">1</span>,] <span class="ot">=</span> No</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we’ve set up a sequence of times and a matrix to hold the results for 20 sample paths. A simple <code>for</code> loop can be used to fill in the rows of <code>n</code>.</p>
<div class="cell" data-hash="02-lab-SDE_cache/html/unnamed-chunk-3_eba03ff6e6e1eec38ab1a7d903074e1e">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(times))) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  newbirths <span class="ot">=</span> <span class="fu">pmax</span>(<span class="dv">0</span>,<span class="fu">births</span>(N[i<span class="dv">-1</span>,])<span class="sc">*</span>stepsize)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  newdeaths <span class="ot">=</span> <span class="fu">pmax</span>(<span class="dv">0</span>,<span class="fu">deaths</span>(N[i<span class="dv">-1</span>,])<span class="sc">*</span>stepsize)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  N[i,] <span class="ot">=</span>  N[i<span class="dv">-1</span>,] <span class="sc">+</span> <span class="fu">rpois</span>(samples,newbirths) <span class="sc">-</span> <span class="fu">rpois</span>(samples,newdeaths)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(times,N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="02-lab-SDE_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Creating a heatmap-like image of the results is another good visualization trick, especially for larger samples.</p>
<div class="cell" data-hash="02-lab-SDE_cache/html/unnamed-chunk-4_afc127d5f6abac988cd986529441efa0">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="fl">1.5</span><span class="sc">*</span>K,<span class="at">length=</span><span class="dv">13</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>breaks[<span class="dv">1</span>] <span class="ot">=</span> <span class="fu">min</span>(N,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>breaks[<span class="dv">13</span>] <span class="ot">=</span> <span class="fu">max</span>(N,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>H <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="fu">length</span>(times),<span class="at">ncol=</span><span class="dv">12</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(times)) { </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    H[i,] <span class="ot">=</span> <span class="fu">hist</span>(N[i,],<span class="at">breaks=</span>breaks,<span class="at">plot=</span><span class="cn">FALSE</span>)<span class="sc">$</span>counts </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(H)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="02-lab-SDE_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Do a few sanity checks before running the <code>for</code> loop. Make sure the breaks do cover the range of <code>N</code>, and that the number of breaks is 12, which is assumed in initializing <code>H</code>.</p>
<p>To compare with the results of the Gillespie SSA, compute a few sample paths that way.</p>
<div class="cell" data-hash="02-lab-SDE_cache/html/unnamed-chunk-5_25304efbd9c39ff7f36ab417c45c13f7">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GillespieSSA2)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>initial_state <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">population =</span> No)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">b =</span> b, <span class="at">d =</span> d, <span class="at">K =</span> K)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>reactions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># propensity function                          effects             name for reaction</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reaction</span>(<span class="st">"b * population"</span>,                      <span class="fu">c</span>(<span class="at">population =</span> <span class="sc">+</span><span class="dv">1</span>), <span class="st">"birth"</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reaction</span>(<span class="st">"(d+(b-d)*population/K) * population"</span>, <span class="fu">c</span>(<span class="at">population =</span> <span class="sc">-</span><span class="dv">1</span>), <span class="st">"death"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>Nssa <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="fu">length</span>(times),<span class="at">ncol=</span>samples)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>samples) {</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ssa</span>(</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">initial_state =</span> initial_state,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">reactions =</span> reactions,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> params,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">ssa_exact</span>(),</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_time =</span> times[<span class="fu">length</span>(times)],</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">census_interval =</span> stepsize,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">log_buffer=</span><span class="cn">TRUE</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>Nssa[,i] <span class="ot">=</span> out<span class="sc">$</span>state</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>breaks[<span class="dv">1</span>] <span class="ot">=</span> <span class="fu">min</span>(Nssa,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>breaks[<span class="dv">12</span>] <span class="ot">=</span> <span class="fu">max</span>(Nssa,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>Hssa <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="fu">length</span>(times),<span class="at">ncol=</span><span class="dv">12</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(times)) { Hssa[i,] <span class="ot">=</span> <span class="fu">hist</span>(Nssa[i,],<span class="at">breaks=</span>breaks,<span class="at">plot=</span><span class="cn">FALSE</span>)<span class="sc">$</span>counts }</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(Hssa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="02-lab-SDE_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>τ-leaping can be done with the <code>ssa</code> routines. Details can be found in help pages for <code>ssa_exact</code>, <code>ssa_etl</code> and <code>ssa_btl</code>.</p>
</section>
<section id="continuous-state-approximations" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="continuous-state-approximations"><span class="header-section-number">4.2</span> Continuous state approximations</h2>
<p>When <span class="math inline">\(\lambda\)</span> is large, the normal distribution with mean <span class="math inline">\(\lambda\)</span> and variance <span class="math inline">\(\lambda\)</span> is a reasonable approximation to the Poisson distribution with rate <span class="math inline">\(\lambda\)</span>. Better still, if <span class="math inline">\(B\)</span> and <span class="math inline">\(D\)</span> are normally distributed random variables with means <span class="math inline">\(\mu_b\)</span> and <span class="math inline">\(\mu_d\)</span>, and variances <span class="math inline">\(\sigma_b^2\)</span> and <span class="math inline">\(\sigma_d^2\)</span> respectively, then the difference, <span class="math inline">\(B-D\)</span>, has a normal distribution with mean <span class="math inline">\(\mu_b-\mu_d\)</span> and variance <span class="math inline">\(\sigma^b+\sigma^2_d\)</span>.</p>
<div class="cell" data-hash="02-lab-SDE_cache/html/unnamed-chunk-6_afeef1ef9a2f2e590434e0f81bac526c">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(times))) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  rate_b <span class="ot">=</span> <span class="fu">births</span>(N[i<span class="dv">-1</span>,])<span class="sc">*</span>stepsize</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  rate_d <span class="ot">=</span> <span class="fu">deaths</span>(N[i<span class="dv">-1</span>,])<span class="sc">*</span>stepsize</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  N[i,] <span class="ot">=</span>  N[i<span class="dv">-1</span>,] <span class="sc">+</span> rate_b<span class="sc">-</span>rate_d <span class="sc">+</span> <span class="fu">sqrt</span>(rate_b<span class="sc">+</span>rate_d)<span class="sc">*</span><span class="fu">rnorm</span>(samples,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-analogous-differential-equation" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="the-analogous-differential-equation"><span class="header-section-number">4.3</span> The analogous differential equation</h2>
<p>Let <span class="math inline">\(N(t)\)</span> be the random variable denoting the population at time <span class="math inline">\(t\)</span>, let <span class="math inline">\(dt\)</span> denote our stepsize, and set <span class="math inline">\(dN(t) = N(t+dt) - N(t)\)</span>. This lets us write the stochastic difference equation in the last code snippet as <span class="math display">\[ dN = (B(N)-D(N))dt + dW\]</span> with <span class="math inline">\(dW\)</span> a normally distributed random variable with mean zero and variance <span class="math inline">\((B(N)-D(N))dt\)</span>. Taking a limit as <span class="math inline">\(dt\to0\)</span> leads us into the realm of stochastic differential equations. Linda Allen <span class="citation" data-cites="Allen2011stochastic">(<a href="#ref-Allen2011stochastic" role="doc-biblioref">Allen 2011</a>)</span> gives a nice treatment of these in the context of biological applications. Our treatment here will be simpler: we’ll ignore <span class="math inline">\(dW\)</span> and just look at the simpler differential equation.</p>
<p><span class="math display">\[\frac{d}{dt}N = B(N) - D(N)\]</span></p>
<p>In the case of our logistic birth and death rates, this is</p>
<p><span class="math display">\[\frac{d}{dt}N = rN(1-N/K)\]</span> with <span class="math inline">\(r = b-d\)</span></p>
<p>As an exercise, solve this separable differential equation via the trick of integrating <span class="math display">\[\int \frac{1}{N(1-N/K)}\, dN = \int r\, dt\]</span> and add the solution to the plot of the stochastic simulation results computed earlier.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Allen2011stochastic" class="csl-entry" role="doc-biblioentry">
Allen, Linda J. S. 2011. <em>An Introduction to Stochastic Processes with Applications to Biology</em>. CRC Press. <a href="https://unb.on.worldcat.org/oclc/908670270">https://unb.on.worldcat.org/oclc/908670270</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./01-lab-BirthProcess.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">The GillespieSSA routines</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>